# Lab1 - CPU 设计报告

**PB15020718 张立夫**

## 设计思路

### Control Unit

该模块主要通过输入的指令，即 `[6:0] Op` 、`[2:0] Fn3`、`[6:0] Fn7` 部分，来决定各个控制信号的值，具体接口已经给定，故只需要根据不同指令的功能（由输入的部分确定具体指令），由组合逻辑控制各个信号进行输出，实现对整个 CPU 的控制。

### NPC Generator

首先根据控制信号判断是否跳转，如果跳转的话，则选取对应的跳转目标地址作为 NPC 的值，否则就按照正常情况 +4 给 NPC。

### SegReg

- IFSegReg：IF 段寄存器，主要功能就是传输下一条指令地址，在本次实验中无需修改；
- IDSegReg：ID 段寄存器，本次实验中，该寄存器中包含了一个同步读写的 Bram，为了避免需要两个时钟周期才能读出数据，所以在该寄存器中调用 Bram，支持 stall 和 clear 功能；
- EXSegReg：EX 段寄存器，支持同步清零，保持状态，本实验中无需修改；
- MEMSegReg：MEM 段寄存器，支持清零，本实验中无需修改；
- WBSegReg：WB 段寄存器，和 ID 段寄存器类似，包含了数据 BRam，支持 stall 和 clear 功能。

### ALU

通过输入的 `AluContrl` 控制信号决定所进行的 ALU 计算操作，对两个输入 `Operand1` 和 `Operand2` 进行计算后输出。

### RegisterFile

作为寄存器存放数据，提供读写功能，在本次实验中无需修改。

### ImmOperandUnit

对立即数进行处理的模块，根据立即数的编码类型输入，确定是哪一个指令类型，再对输入的立即数处理为所需的指令类型格式进行输出。

### BranchDecisionMaking

在 EX 段确定是否进行跳转，根据控制信号 `BranchTypeE` 的数值，对输入的两个操作数进行组合逻辑运算（如相减等），根据结果判断是否进行跳转，如果跳转则将 `BranchE` 置为 1，使 NPC Generator 进行 PC 的修改。

### DataExt

该模块处理非字对齐的 load 操作，其中控制信号为 `LoadedBytesSelect` 和 `RegWriteW` ，其中 `LoadedBytesSelect` 指示所读取的数据地址起始位置，`RegWriteW` 指示数据的长度以及进行符号位扩展还是进行无符号位扩展。根据上面两个控制信号的不同搭配，对从 Data Mem 中的数据进行对应的符号位扩展，然后再写入寄存器。

### HarzardUnit

该模块处理流水线的冲突问题。

#### Forward

对于数据相关可以使用转发解决的情况有两种：

- ALU 的一个源操作数是上一条指令的 ALU 运算结果；
- ALU 的一个源操作数是上上一条 load 指令的读取结果；

#### Stall

对于以下数据相关需要在流水线中插入气泡，即对各个段寄存器进行 Stall

- 本条指令的源操作数为上一条 load 指令的读取结果；

对于控制相关有：

- 当进行分支时，如果分支成功跳转，则将对应段及之前的段寄存器进行清零，重新取址进行指令执行；
- 当进行跳转时，对于不同阶段的跳转，同样将对应段及之前的段寄存器清零，重新取址。



## 回答问题

1. 为什么将 DataMemory 和 InstructionMemory 嵌入在段寄存器中？

   答：因为使用的是 Bram，如果不嵌入在段寄存器中，需要一个时钟上升沿从 Bram 中读取出数据，再经过一个时钟上升沿从段寄存器中读出来，一共经过两个时钟周期，所以要嵌入在段寄存器中。

2. DataMemory 和 InstructionMemory 输入地址是字（32bit）地址，如何将访存地址转化为字地址输入进去？

   答：要转化为字地址只需要将访存地址的最低两位置为零即可。

3. 如何实现 DataMemory 的非字对齐的 Load？

   答：通过在 WB 阶段的 DataExt 模块，对取出来的 32bit 数据进行处理，根据初始地址选择数据的某一部分，然后进行相应的符号位扩展，之后再存到寄存器中。

4. 如何实现 DataMemory 的非字对齐的 Store？

   答：通过 IP 核的独热码的控制信号，进行对某一个单字节的写入。

5. 为什么 RegFile 的时钟要取反？

   答：如果是上升沿写入的话，则需要在第六个周期才能将数据写回到寄存器中，会增加一个周期，所以选择在下降沿有效。

6. NPC_Generator 中对于不同跳转 target 的选择有没有优先级？

   答：有优先级，执行的阶段越靠后的指令优先级越高。

7. ALU 模块中，默认 wire 变量是有符号数还是无符号数？

   答：这个变量可以自己定义是有符号数还是无符号数。

8. AluSrc1E 执行哪些指令时等于 1'b1？

   答：在执行跳转指令时，需要重新计算 PC 地址的时候等于 1'b1。

9. AluSrc2E 执行哪些指令时等于 2'b01？

   答：在执行不需要 Rs2 的指令时等于 2'b01，如左移、右移、Load、Store 等。

10. 哪条指令执行过程中会使得 LoadNpcD==1？

    答：在非跳转和分支指令的执行过程中，会使 LoadNpcD==1，该控制信号指示 NPC = PC + 4。

11. DataExt 模块中，LoadedBytesSelect 的意义是什么？

    答：LoadedBytesSelect 指示所读取的数据地址起始位置，使得从 DataMem 中独取出来的数据可以正确的选取到所需要的字节段，即实现非字对齐的 Load 指令。

12. Harzard 模块中，有哪几类冲突需要插入气泡？

    答：只有在 Load 指令后面紧跟着一条使用该 Load 指令所读取出来的数据的时候，会需要插入气泡。

13. Harzard 模块中采用默认不跳转的策略，遇到 branch 指令时，如何控制 flush 和 stall 信号？

    答：如果需要跳转，则清空此时处于 ID 和 IF 阶段的两条指令，即利用 flush 信号清空 ID 和 IF 段寄存器，如果不需要跳转，则无需进行任何操作即可。

14. Harzard 模块中，RegReadE 信号有什么用？

    答：分别表示寄存器的两个源操作数是否会被用到，如果用到了，再进一步判断地址是否相同，以此用来判断是否和上一条进行了写回操作的指令发生数据相关的冲突。

15. 0 号寄存器值始终为 0，是否会对 forward 的处理产生影响？

    答：会产生影响，因为对 0 号寄存器写入是无效的，而如果下一条指令用到了 0 号寄存器，这样的转发策略就有可能会使下一条指令取到非零值。